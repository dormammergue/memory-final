<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Welcome!</title>

    <!--jQuery-->
    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
        crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
    <!--external style sheets-->
    <link rel="stylesheet" href="./styles/style.css">
</head>

<body>
    <jumbotron><img src='./images/top.jpg' width='100%'></jumbotron>

                <!--MODAL-->
                <button type="button" class="btn btn-info btn-lg upload" data-toggle="modal" data-target="#myModal" style='float: right; margin: 0% right;'>Add a New Memory</button>
                <!--FINISH MODAL-->

    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div class="display-results"></div>
            </div>
            <div class="col-md-9">

             

                <div class="view-larger">
                    Click on a memory to see it larger and read more details on this screen!
                </div>
            </div>
        </div>
    </div>

    <!--MODAL-->
    <!-- Trigger the modal with a button -->


<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Upload a New Memory</h4>
      </div>
      <div class="modal-body">
        <div class="uploaddiv">
        <form enctype="multipart/form-data" id="form">
            <input type="text" id="imagetitle" placeholder="Image Title"><br>
            <input type="text" id="imageposter" placeholder="Who is posting/(User)?"><br>
            <input type="text" id="imageowner" placeholder="Who owns it?"><br>
            <input type="text" id="imagewhere" placeholder="Where is it from?"><br>
            <input type="text" id="imagewho" placeholder="Who is it from?"><br>
            <input type="text" id="description" placeholder="Describe the Item"><br>
            <select name="category" id="category">
            <option value=""> Choose a Category:</option>
            <option value="Heirloom">Heirloom</option>
            <option value="Art">Art</option>
            <option value="Jewelry">Jewelry</option>
            <option value="Christmas">Christmas</option>
            <option value="Misc">Misc.</option>
        </select><br>
            <input type="file" id="fileupload" name="myfile"><br><br>
            <button id="submit">Submit Memory</button>
        </form>
        </span>
    </div>
    </div>
        <script>
         $('#submit').click(function (evt) {
            var memoryDescription =
                $("#description").val();

            var memoryCategory =
                $('#category').val();

            var memoryTitle =
                $('#imagetitle').val();

            var memoryPoster =
                $('#imageposter').val();

            var memoryOwner =
                $('#imageowner').val();

            var memoryLocation =
                $('#imagewhere').val();

            var memoryGiver =
                $('#imagewho').val();
            evt.preventDefault();
            console.log(new FormData($('#form')[0]));
            $.ajax({
                url: '/savefile',
                type: 'POST',
                data: new FormData($('#form')[0]),
                cache: false,
                contentType: false,
                processData: false,
                success: function (filename) {
                    console.log(filename)
                    // $('#output').attr({
                    //     'src': '/uploads/' + filename
                    // });
                    $.post("/api/newMemory/", {
                        title: memoryTitle,
                        user: memoryPoster,
                        owner: memoryOwner,
                        giver: memoryGiver,
                        description: memoryDescription,
                        category: memoryCategory,
                        picture: filename,

                    }, function (memory) {
                        alert('you just posted!');
                    });
                }
            });
        });

        $("#submitMemory").click(function () {
            //get contents of memory
            var memoryDescription =
                $("#description").val();

            var memoryCategory =
                $('#category').val();

            var memoryTitle =
                $('#imagetitle').val();

            var memoryPoster =
                $('#imageposter').val();

            var memoryOwner =
                $('#imageowner').val();

            var memoryLocation =
                $('#imagewhere').val();

            var memoryGiver =
                $('#imagewho').val();


            //send memory to server

        });
            </script>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" id='modalbutton'>Close</button>
      </div>
    </div>

  </div>
</div>


</body>
<footer><hr>
    <center>
        <img src="./images/forgetmenotheart.png">
        <br>&copy; 2017 Flyndyl&trade;
    </center>
    </footer>

<script>


    function buildAndDisplayMemory(memory) {
        $(".display-results").prepend(
            `<hr><div id='${memory._id}' class='memorydisplay'>
                <span class='image'>
                    <img src='../uploads/${memory.picture}' class="thumbnails" id=${memory.picture} data-memoryId="${memory._id}">
                </span>
                <span class="memoryInfo">
                     <span class='title'>
                        <h4><b><u>
                            ${memory.title}
                            </u></b>
                                <br>
                                ${memory.category}
                            </h4>    
                        </span>
                        <br>
                    </span>
                 </span>    
            </div>`
        ); //closes out append after~display results
    }

    function buildAndDisplayLargerMemory(memory, picture, giver, title, category, user, owner, description) {
        $(".view-larger").text('');
        console.log(memory, picture)
        $(".view-larger").append(`
    <div class='larger-image'>
        <img 
            src='../uploads/${picture}' 
            class='larger'>
        <br>
        <span class='largetitle'><h1>${title}</h1></span>
        <span class='largeinfo'><sup>Submitted by ${user} </sup>
        <br><img src="http://forgetmenotgts.co.uk/wp-content/themes/fmn/img/logo.png" class='drawnforgetmenot'>
        <div class='largedescription'>
            ${description}
        </div><br>
         <div class='largeinfo'>Given by ${giver}
            <br>
            Category: ${category}<br>
            Owned By: ${owner}
            </span>
        </div>
    </div>`
    )};

    function buildClickHandler() {
        var memoryId = memory._id;
        var memorypicture = this.memory.picture;
        var memorygiver = this.memory.giver; 
        var memorytitle = this.memory.title; 
        var memorycategory = this.memory.category;
        var memoryuser = this.memory.user;
        var memoryowner = this.memory.owner;
        var memorydescription = this.memory.description;
         $(`#${memoryId}`).click(function () {
            buildAndDisplayLargerMemory(memoryId, memorypicture, memorygiver, memorytitle, memorycategory, memoryuser, memoryowner, memorydescription);
            //  console.log(memory.picture)
            // var memoryId = this.dataset.memoryId;
            // console.log(memoryId);
            // var imageLink = $(`#${memoryId}`).find(`#${memory.picture}`);
            // console.log(imageLink);
        });
    }



    $.get("/api/memories", function (memories) {
        for (memory of memories) {
            buildAndDisplayMemory(memory);
            $('.thumbnails').click(buildClickHandler()
        )}; 
        // buildAndDisplayLargerMemory(memories[memories.length - 2]);
    }); //closes out $.get

$('.close').click(function() {
    location.reload();
});
$('#modalbutton').click(function(){
    location.reload();
});
        
</script>

</html>